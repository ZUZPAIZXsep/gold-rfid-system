<%- include('header') %>

<div>
    <%
      let totalTags = golds.length;
    %>
    <table style="width: 95%; border-collapse: collapse; margin: 10px auto; table-layout: fixed;">
        <!-- Row 1: Total gold count (No border) -->
        <tr>
          <th colspan="5" style="color: white; background-color: #4CAF50; padding: 25px; border-radius: 5px; font-size: 28px; text-align: center;">
            จำนวนทองคำในระบบที่คงเหลือ<br>
          </th>
        </tr>

        <!-- Row 2: Types of gold (With border) -->
        <tr>
          <% 
            const goldTypes = { 
              'สร้อยคอ': 'necklace', 
              'แหวน': 'ring', 
              'กำไลข้อมือ': 'bangle', 
              'สร้อยข้อมือ': 'bracelet', 
              'ต่างหู': 'earrings' 
            }; 
      
            const icons = {
              'สร้อยคอ': '/images/gold-necklace.png',
              'แหวน': '/images/gold-ring.png',
              'กำไลข้อมือ': '/images/gold-bangle.png',
              'สร้อยข้อมือ': '/images/gold-bracelet.png',
              'ต่างหู': '/images/gold-earrings.png'
            };
            
            Object.keys(goldTypes).forEach(type => {
              const count = golds.filter(tag => tag.gold_type === type).length;
              if (count >= 0) { 
          %>
              <td style="padding: 10px; background-color: #f0f8ff; border-radius: 5px; text-align: center; border: 1px solid black; width: 20%;">
                <button class="type-button" onclick="showTypeDetails('<%= type %>')" style="width: 100%; padding: 10px; background-color: #f0f8ff; border: none;">
                  <span style="font-weight: bold; color: green;font-size: 20px;"><%= type %></span><br>
                  <img src="<%= icons[type] %>" alt="Icon" style="width: 30px; height: 30px; vertical-align: middle; margin-top: 8px;">
                </button>
              </td>
          <% 
              }
            }); 
          %>
        </tr>

        <!-- Row 3: Gold counts (With border) -->
        <tr>
          <% 
            Object.keys(goldTypes).forEach(type => {
              const count = golds.filter(tag => tag.gold_type === type).length;
              if (count >= 0) { 
          %>
              <td style="padding: 10px; text-align: center; border: 1px solid black; width: 20%;background-color: white;">
                <span style="color: black; font-size: 20px;"><%= count %> ชิ้น</span>
              </td>
          <% 
              }
            }); 
          %>
        </tr>
    </table>

    <!-- พื้นที่แสดงข้อมูลขนาดทอง -->
    <div id="type-details" style="display:none; margin-top: 20px; margin-left: 50px;"></div>

    <!-- ตารางสำหรับแสดงรายการสินค้าที่เพิ่มลงตะกร้า -->
    <div style="float: right; margin-right: 5%; margin-top: 30px; width: 40%;">
      <h4>รายการสั่งซื้อ</h4>
      <table id="cartTable" style="width: 100%; border-collapse: collapse; margin: 10px auto; table-layout: fixed; border: 1px solid black;">
          <thead>
              <tr>
                  <th>รหัสสินค้า</th>
                  <th>ประเภททองคำ</th>
                  <th>ขนาด</th>
                  <th>จำนวน</th>
                  <th></th>
              </tr>
          </thead>
          <tbody id="cartItems">
              <!-- รายการที่เพิ่มจะถูกแสดงในตารางนี้ -->
          </tbody>
      </table>
    </div>

    <!-- Form for Ordering Gold -->
    <form action="/order_gold" method="POST" style="margin-top: 30px; margin-left: 2.5%; width: 25%;">
        <h5>ข้อมูลผู้จัดจำหน่าย</h5>
        <div class="form-group">
            <label for="order_date">วันที่สั่ง</label>
            <input type="text" name="order_date" value="<%= currentDate %>" class="form-control" readonly/>
        </div>
        <div class="form-group mt-2">
          <label for="dealer">เลือกผู้จัดจำหน่าย</label>
          <select name="dealer" id="dealer" class="form-select" required>
            <option selected disabled>เลือกผู้จัดจำหน่าย</option>
            <% dealers.forEach(dealer => { %>
              <option value="<%= dealer.dealer_name %>"><%= dealer.dealer_name %></option>
            <% }); %>
          </select>
        </div>
        <div class="form-group mt-3">
            <label for="dealer_address">ที่อยู่</label>
            <textarea type="text" name="dealer_address" class="form-control" rows="3" readonly></textarea>
        </div>
        <div class="form-group mt-2">
            <label for="dealer_phone">เบอร์โทร</label>
            <input type="text" name="dealer_phone" class="form-control" readonly/>
        </div>
        <div class="form-group mt-2">
            <label for="dealer_fax">เบอร์แฟกซ์</label>
            <input type="text" name="dealer_fax" class="form-control" readonly/>
        </div>

        <h5 class="mt-3">ข้อมูลสินค้า</h5>
        <div class="form-group mt-2">
            <label for="gold_type_id">รหัสสินค้า</label>
            <input type="text" id="gold_type_id" name="gold_type_id" class="form-control" readonly />
        </div>
        <div class="form-group mt-2">
            <label for="goldType">ประเภททองคำ</label>
            <select name="goldType" id="goldType" class="form-select" required>
                <option selected disabled>เลือกประเภททองคำ</option>
                <% Object.keys(goldTypes).forEach(type => { %>
                    <option value="<%= type %>"><%= type %></option>
                <% }); %>
            </select>
        </div>

        <div class="form-group mt-2">
            <label for="goldSize">ขนาด</label>
            <select name="goldSize" id="goldSize" class="form-select" required>
                <option selected disabled>เลือกขนาดทองคำ</option>
                <option value="ครึ่งสลึง">ครึ่งสลึง</option>
                <option value="1 สลึง">1 สลึง</option>
                <option value="2 สลึง">2 สลึง</option>
                <option value="1 บาท">1 บาท</option>
                <option value="2 บาท">2 บาท</option>
                <option value="3 บาท">3 บาท</option>
            </select>
        </div>

        <div class="form-group mt-2">
            <label for="quantity">จำนวนที่ต้องการสั่ง</label>
            <input type="number" id="quantity" name="quantity" class="form-control" min="1" required>
        </div>
        <button type="submit" class="btn btn-success mt-3">บันทึก</button>
        <button type="button" id="addToCartBtn" class="btn btn-primary mt-3">เพิ่มรายการ</button>
    </form>

</div>

<%- include('footer') %>

<script>
  const golds = JSON.parse('<%- JSON.stringify(golds) %>');

  function showTypeDetails(type) {
    const typeGolds = golds.filter(gold => gold.gold_type === type);
    
    const sizes = {
      'ครึ่งสลึง': 0,
      '1 สลึง': 0,
      '2 สลึง': 0,
      '1 บาท': 0,
      '2 บาท': 0,
      '3 บาท': 0
    };

    // นับจำนวนขนาดทองตามประเภท (gold_size)
    typeGolds.forEach(gold => {
      if (sizes[gold.gold_size] !== undefined) {
        sizes[gold.gold_size]++;
      }
    });

    let detailsHTML = `<h3>ประเภท: ${type}</h3><ul>`;
    Object.keys(sizes).forEach(size => {
      detailsHTML += `<li>${size}: ${sizes[size]} ชิ้น</li>`;
    });
    detailsHTML += `</ul>`;

    const typeDetailsDiv = document.getElementById('type-details');
    typeDetailsDiv.innerHTML = detailsHTML;
    typeDetailsDiv.style.display = 'block';
  }

  // ปรับ CSS เมื่อกดปุ่ม
  document.querySelectorAll('.type-button').forEach(button => {
    button.addEventListener('click', function() {
      document.querySelectorAll('.type-button').forEach(btn => {
        btn.style.backgroundColor = '#f0f8ff';  // สีปกติ
      });
      this.style.backgroundColor = '#d0e8ff';   // สีเมื่อกด
    });
  });

  // ฟังก์ชันเติมขนาดทองเมื่อเลือกประเภท
  function populateGoldSizes() {
    const selectedType = document.getElementById('goldType').value;
    const goldSizeSelect = document.getElementById('goldSize');

    // รีเซ็ต dropdown ขนาดทอง
    goldSizeSelect.innerHTML = '<option value="">เลือกขนาดทอง</option>';
    goldSizeSelect.disabled = true;

    if (selectedType) {
      const sizes = [...new Set(golds.filter(gold => gold.gold_type === selectedType).map(gold => gold.gold_size))];
      
      sizes.forEach(size => {
        const option = document.createElement('option');
        option.value = size;
        option.textContent = size;
        goldSizeSelect.appendChild(option);
      });

      goldSizeSelect.disabled = false;
    }
  }

  
  document.getElementById('dealer').addEventListener('change', function() {
    const dealerName = this.value;
    
    // ส่ง AJAX ไปที่เซิร์ฟเวอร์เพื่อดึงข้อมูลผู้จัดจำหน่าย
    fetch(`/dealer_info/${dealerName}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.querySelector('textarea[name="dealer_address"]').value = data.dealer.address;
          document.querySelector('input[name="dealer_phone"]').value = data.dealer.phone;
          document.querySelector('input[name="dealer_fax"]').value = data.dealer.fax;
        } else {
          alert('ไม่พบข้อมูลผู้จัดจำหน่าย');
        }
      })
      .catch(error => console.error('Error:', error));
  });

  
  document.getElementById('goldType').addEventListener('change', function() {
    const goldTypeIdInput = document.getElementById('gold_type_id');
    const selectedType = this.value;

    // ตรวจสอบประเภททองคำและกำหนดรหัสสินค้า
    let typeId = '';
    switch (selectedType) {
        case 'สร้อยคอ':
            typeId = 'A001';
            break;
        case 'แหวน':
            typeId = 'B002';
            break;
        case 'กำไลข้อมือ':
            typeId = 'C003';
            break;
        case 'สร้อยข้อมือ':
            typeId = 'D004';
            break;
        case 'ต่างหู':
            typeId = 'E005';
            break;
        default:
            typeId = '';
    }

    // อัปเดตค่าในช่องรหัสสินค้า
    goldTypeIdInput.value = typeId;
});

  // ฟังก์ชันสำหรับเพิ่มรายการลงในตะกร้า
  document.getElementById('addToCartBtn').addEventListener('click', function() {
    const goldType = document.getElementById('goldType').value;
    const goldSize = document.getElementById('goldSize').value;
    const quantity = document.getElementById('quantity').value;
    const goldTypeId = document.getElementById('gold_type_id').value;

    // ตรวจสอบว่าข้อมูลที่จำเป็นถูกเลือกแล้ว
    if (!goldType || !goldSize || !quantity || quantity <= 0) {
      alert('กรุณากรอกข้อมูลให้ครบถ้วน');
      return;
    }

    // สร้างแถวใหม่ในตาราง
    const cartTable = document.getElementById('cartItems');
    const newRow = document.createElement('tr');

    newRow.innerHTML = `
      <td>${goldTypeId}</td> <!-- เพิ่มรหัสสินค้า -->
      <td>${goldType}</td>
      <td>${goldSize}</td>
      <td>${quantity}</td>
      <td><button class="remove-btn btn btn-danger">ลบ</button></td>
    `;

    // เพิ่มแถวใหม่ลงในตาราง
    cartTable.appendChild(newRow);

    // ลบรายการออกจากตะกร้า
    newRow.querySelector('.remove-btn').addEventListener('click', function() {
      newRow.remove();
    });

    // เคลียร์ฟอร์มหลังจากเพิ่มรายการ
    document.getElementById('goldType').value = '';
    document.getElementById('goldSize').value = '';
    document.getElementById('quantity').value = '';
    document.getElementById('gold_type_id').value = '';
  });

</script>