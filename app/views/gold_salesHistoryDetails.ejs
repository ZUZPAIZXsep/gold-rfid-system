<%- include('header') %>

<div class="container-fluid">
    <div class="watermark">Gold Inventory System</div> <!-- Watermark -->
    <h1 class="mt-3">รายละเอียดการขายทองคำ</h1>
    <h5 class="mt-3">จำนวนรายการทองคำที่ขายทั้งหมด: <%= outStockCount %> รายการ</h5>

    <table class="table table-bordered mt-3">
        <thead class="table-success">
            <tr>
                <th>Gold Tag ID</th>
                <th>ประเภททองคำ</th>
                <th>ขนาดทองคำ</th>
                <th>น้ำหนัก (กรัม)</th>
                <th>ร้านผู้จัดจำหน่าย</th>
                <th>ราคา</th>
            </tr>
        </thead>
        <tbody>
            <% details.forEach((detail) => { %>
                <tr>
                    <td><%= detail.gold_id %></td>
                    <td><%= detail.gold_type %></td>
                    <td><%= detail.gold_size %></td>
                    <td><%= detail.gold_weight %></td>
                    <td><%= detail.dealer_name %></td>
                    <td><%= detail.gold_price %></td>
                </tr>
            <% }); %>
        </tbody>
    </table>
    
    <div class="mt-3">
        <h6>ผู้ซื้อ: 
            <% if (details.length > 0) { %>
                <%= details[0].customer_name + " " + details[0].customer_surname %> 
            <% } else { %>
                ไม่มีข้อมูลผู้ซื้อ
            <% } %>
        </h6>
        <h6>ผู้ทำการขาย: 
            <% if (details.length > 0) { %>
                <%= details[0].seller_name %>
            <% } else { %>
                ไม่มีข้อมูลผู้ขาย
            <% } %>
        </h6>
        <!-- หากต้องการแสดงผู้ซื้อหรือผู้ขายหลายคนเป็นข้อความ เช่น "หลายคน" -->
        <!-- 
        <h6>ผู้ซื้อ: 
            <%= details.some(detail => detail.customer_name !== details[0].customer_name) ? "หลายคน" : details[0].customer_name + " " + details[0].customer_surname %> 
        </h6>
        <h5>ผู้ขาย: 
            <%= details.some(detail => detail.seller_name !== details[0].seller_name) ? "หลายคน" : details[0].seller_name %>
        </h6> 
        -->
    </div>

    <!-- แสดงเวลาที่ขายด้านล่าง -->
    <div class="mt-4 d-flex justify-content-between">
        <h5>เวลาที่ทำการขาย: 
            <% if (details.length > 0) { %>
                <%= dayjs(details[0].gold_outDateTime).format('DD-MM-YYYY HH:mm:ss') %>
            <% } else { %>
                ไม่มีข้อมูลเวลาที่ขาย
            <% } %>
        </h5>
        <h4>ราคารวม: <%= totalPrice.toLocaleString() %> บาท</h4>
    </div>
    <!-- รูปภาพ -->
    <img id="goldIcon" src="/images/gold-bars.png" alt="icon" style="height: 96px; width: 96px; margin-right: 10px;"/>
    <!-- ปุ่มสร้าง PDF -->
    <button class="btn btn-secondary mt-3" onclick="printReceipt()">พิมพ์ใบเสร็จ</button>
    <button class="btn btn-secondary mt-3" onclick="generatePDF()">ดาวน์โหลด PDF</button>
    <a href="/gold_salesHistory" class="btn btn-primary mt-3">กลับไปหน้ารายการทั้งหมด</a>
</div>

<%- include('footer') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>

    function printReceipt() {
        window.print();
    }

    function generatePDF() {
        var element = document.querySelector('.container-fluid');
        html2pdf()
            .from(element)
            .save('receipt<%= dayjs(details[0].gold_outDateTime)%>.pdf');
    }

</script>

<style>
    /* ซ่อน watermark ในสภาวะปกติ */
    .watermark {
        visibility: hidden;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg); /* หมุนเป็นแนวทแยง */
        font-size: 50px;
        color: rgba(0, 0, 0, 0.1); /* สีจาง */
        white-space: nowrap;
        z-index: 10000;
        pointer-events: none;
        opacity: 0; /* ซ่อนแบบใช้ opacity */
    }
    /* ปกติซ่อนรูปภาพ */
    #goldIcon {
        display: none;
    }

    /* ซ่อนคอลัมน์ gold_id และ dealer_name ตอนพิมพ์ */
    @media print {
        /* ซ่อน header, ปุ่ม, และส่วนที่ไม่ต้องการ */
        header, .navbar, footer, .gold-icon, .btn, .mt-4.d-flex {
            display: none;
        }

        /* แสดงเนื้อหาหลัก */
        .container-fluid, .container-fluid * {
            visibility: visible;
        }

        /* แสดง watermark */
        .watermark {
            visibility: visible;
            opacity: 1; /* แสดง watermark */
        }

        /* ซ่อนคอลัมน์ gold_id และ dealer_name */
        th:nth-child(1), td:nth-child(1), /* ซ่อน gold_id */
        th:nth-child(5), td:nth-child(5)  /* ซ่อน dealer_name */ {
            display: none;
        }
        /* แสดงรูปภาพเฉพาะตอนพิมพ์ */
        #goldIcon {
            display: block;        /* แสดงรูปภาพ */
            filter: hue-rotate(180deg); /* เปลี่ยนสีรูปเป็นสีน้ำเงิน */
            position: absolute;    /* ใช้ absolute เพื่อควบคุมตำแหน่ง */
            right: 50px;           /* วางรูปภาพทางด้านขวา */
            margin-top: 50px; /* เพิ่มระยะห่างด้านบน */
            transform: translate(-50%, -50%) rotate(-15deg); /* หมุนเป็นแนวทแยง */
            opacity: 0.3;                /* ปรับความโปร่งใสให้สีจางลง */
        }

        /* ปรับตำแหน่งของราคารวมให้สอดคล้องกับรูปภาพ */
        .mt-4.d-flex {
            display: block;
            position: relative;    /* ใช้ relative เพื่อให้ภาพอ้างอิงตำแหน่งนี้ */
        }
    }
</style>
